
#include "adpcm.h"

void init(int test_data[MAX_SIZE])
{
	/* reset, initialize required memory */

#if(TEST_VECTOR)

#else

	int i, j, f;
	int x = 0;

	/* read in amplitude and frequency for test data */
	//j = 100;
	j=10;
	f = 20000;

	/* 16 KHz sample rate */
	/* XXmain_0, MAX: 2 */
	/* Since the number of times we loop in my_sin depends on the argument we
	   add the fact: xxmain_0:[]: */
	for(i = 0 ; i < SIZE ; i++) {
		test_data[i] = (int) j * adpcm_cos(f * PI * i);
		//test_data[i] = (int) j*sin(2*f*i*3.14159265);

		test_data[i] += x;
	}

#endif
}

int enc_return(int compressed[MAX_SIZE])
{
	int i;
	int check_sum = 0;


	for(i = 0 ; i < SIZE ; i += 2) {
		check_sum += compressed[i/2];
	}

	return check_sum != 385;
}

int dec_return(int dec_result[MAX_SIZE])
{
	int i;
	int check_sum = 0;

	for(i = 0; i < SIZE; i++) {
		check_sum += (dec_result[i]);
	}

	return check_sum != -2;
}

int main()
{
	int i;
	int err_cnt = 0;

	/* Input data for the decoder usually generated by the encoder. */
	int compressed[MAX_SIZE] = {0};
	//int compressed[SIZE];
	/* Output data frome the decoder */
	int dec_result[MAX_SIZE] = {0};

#if(TEST_VECTOR)

	int test_data[SIZE] = {
		0x44, 0x44, 0x44, 0x44, 0x44,
		0x44, 0x44, 0x44, 0x44, 0x44,
		0x44, 0x44, 0x44, 0x44, 0x44,
		0x44, 0x44, 0x43, 0x43, 0x43,
		0x43, 0x43, 0x43, 0x43, 0x42,
		0x42, 0x42, 0x42, 0x42, 0x42,
		0x41, 0x41, 0x41, 0x41, 0x41,
		0x40, 0x40, 0x40, 0x40, 0x40,
		0x40, 0x40, 0x40, 0x3f, 0x3f,
		0x3f, 0x3f, 0x3f, 0x3e, 0x3e,
		0x3e, 0x3e, 0x3e, 0x3e, 0x3d,
		0x3d, 0x3d, 0x3d, 0x3d, 0x3d,
		0x3c, 0x3c, 0x3c, 0x3c, 0x3c,
		0x3c, 0x3c, 0x3c, 0x3c, 0x3b,
		0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x3b, 0x3b, 0x3c, 0x3c, 0x3c,
		0x3c, 0x3c, 0x3c, 0x3c, 0x3c
	};

	int test_compressed[SIZE] = {
		0xfd, 0xde, 0x77, 0xba, 0xf2,
		0x90, 0x20, 0xa0, 0xec, 0xed,
		0xef, 0xf1, 0xf3, 0xf4, 0xf5,
		0xf5, 0xf5, 0xf5, 0xf6, 0xf6,
		0xf6, 0xf7, 0xf8, 0xf7, 0xf8,
		0xf7, 0xf9, 0xf8, 0xf7, 0xf9,
		0xf8, 0xf8, 0xf6, 0xf8, 0xf8,
		0xf7, 0xf9, 0xf9, 0xf9, 0xf8,
		0xf7, 0xfa, 0xf8, 0xf8, 0xf7,
		0xfb, 0xfa, 0xf9, 0xf8, 0xf8
	};

	int test_result[SIZE] = {
		0, 0xffffffff, 0xffffffff, 0, 0,
		0xffffffff, 0, 0, 0xffffffff, 0xffffffff,
		0, 0, 0x1, 0x1, 0,
		0xfffffffe, 0xffffffff, 0xfffffffe, 0, 0xfffffffc,
		0x1, 0x1, 0x1, 0xfffffffb, 0x2,
		0x2, 0x3, 0xb, 0x14, 0x14,
		0x16, 0x18, 0x20, 0x21, 0x26,
		0x27, 0x2e, 0x2f, 0x33, 0x32,
		0x35, 0x33, 0x36, 0x34, 0x37,
		0x34, 0x37, 0x35, 0x38, 0x36,
		0x39, 0x38, 0x3b, 0x3a, 0x3f,
		0x3f, 0x40, 0x3a, 0x3d, 0x3e,
		0x41, 0x3c, 0x3e, 0x3f, 0x42,
		0x3e, 0x3b, 0x37, 0x3b, 0x3e,
		0x41, 0x3b, 0x3b, 0x3a, 0x3b,
		0x36, 0x39, 0x3b, 0x3f, 0x3c,
		0x3b, 0x37, 0x3b, 0x3d, 0x41,
		0x3d, 0x3e, 0x3c, 0x3e, 0x3b,
		0x3a, 0x37, 0x3b, 0x3e, 0x41,
		0x3c, 0x3b, 0x39, 0x3a, 0x36
	};

#else

	/* Input data for the encoder usually generated by the init function. */
	int test_data[MAX_SIZE];

#endif

	init(test_data);

	adpcm_main(test_data, compressed, dec_result, 0, SIZE);
	adpcm_main(test_data, compressed, dec_result, 1, SIZE);

#if(TEST_VECTOR)

	for(i = 0; i < SIZE; i++) {
		if(dec_result[i] != test_result[i]) {
			err_cnt++;
		}
	}

	if(err_cnt) {
		printf("ERROR: %d\n", err_cnt);
	} else {
		printf("Test Passes:\n");
	}

	return 0;

#else

	printf("Return: %d\n", enc_return(compressed));
	printf("Return: %d\n", dec_return(dec_result));

	return 0;

#endif

}
